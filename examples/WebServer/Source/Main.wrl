// Define the main module.
module Main;

// Import necessary modules from the Core library.
use Core.{
    Http.{ 
        HttpServer, ServerOutcome, HttpRequest, HttpResponse,
        Middleware, MiddlewareResponse, HttpRequestError
    },
    Io.{Fmt, Print},
    Crypto.JwtEncryptor,
    Process.GetEnv
};

/// Entry point into the program.
public function Main() { 
    // Set up server configurations.
    name := "simple-server";
    port := 8080;
    app := new HttpServer(name, port);
    middleware := new Middleware();
    printMessage := fn() {
        template := Fmt("% is listening on %.");
        message := template.Add(name).Add(port).Finish();
        Print(message)
    };
    // Register authentication.
    middleware.Use(AuthenticationHandler);
    // Apply middleware to the server.
    app.UseMiddleware(middleware);
    // Define routes.
    // Route 1: Basic "Hello, World!" response.
    app.Get("/hello", HelloHandler);
    // Route 2: Parameterized greeting.
    app.Get("/greet/:name", GreetHandler);
    // Route 3: Static file serving.
    app.Get("/static/::filename", StaticFileHandler);
    // Start the server and handle subsequent actions.
    app.Start().Then(printMessage).Run();
}

/// Handler function for the "/hello" endpoint.
async function HelloHandler(request: HttpRequest): ServerOutcome {
    response := HttpResponse.From(&request);
    response.Status(200).Html("<h1>Hello, world!</h1>");
    Ok(response)
}

/// Handler function for authenticating users.
async function AuthenticationHandler(req: HttpRequest): MiddlewareResponse {
    if req.Url().StartsWith("/user/") {
        auth := req.Headers().GetOrErr("auth")?;
        token := if !auth.StartsWith("Bearer ") {
            return Err(req.CreateError("Invalid authentication header."));
        } else {
            auth.Slice(7..auth.Length()).Unwrap()
        };
        maybeSecret := GetEnv("JWT_SECRET");
        if maybeSecret.IsNone() {
            return Err(req.CreateError("Unauthorized Request."));
        };
        secret := maybeSecret.Unwrap();
        decoded := JwtEncryptor.Decode(*token, *secret);
        req.StoreData("user-id", decoded);
        return Ok(req);
    }
    return Ok(req);
}

/// Handler function for the "/greet/:name" endpoint.
async function GreetHandler(req: HttpRequest): ServerOutcome {
    name := req.PathParams().GetOrErr("name")?;
    response := req.Respond();
    response.Status(200).Html("<h1>Hello, " + name + "!</h1>");
    return Ok(response);
}

// Handler function for serving static files.
async function StaticFileHandler(req: HttpRequest): ServerOutcome {
    filename := req.PathParams().Get("filename");
    // Implement logic to read and serve the specified static file.
    response := req.Respond();
    return Ok(response);
}
